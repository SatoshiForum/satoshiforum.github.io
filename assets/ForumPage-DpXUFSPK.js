import{_ as A,c as b,o as m,a as i,b as o,w as l,d as _,r as a,e as F,f as R,g as v,t as d,F as T,h as q,E as g,C as P,N as S,U as j,u as M}from"./index-iyfmY-EO.js";const Y={name:"ForumPage",data(){return{totalPostCount:0,postCost:0,categoryList:[],postCache:{},curPagePosts:[],currentPage:1,pageSize:20,loading:!1,showPostDialog:!1,posting:!1,newPost:{title:"",category:"",content:""}}},computed:{userStore(){return M()},totalPosts(){return this.totalPostCount}},async mounted(){let n=this;if(this.timer=setInterval(async()=>{const t=await P.queryForumBatchInfo(),c=parseInt(t.postCount);c!=n.totalPostCount&&n.currentPage==1&&(n.totalPostCount=c,n.loadCurrentPage(!1))},4e3),j.registerEventByType("nameEntryUpdate",function(t){for(const c of n.curPagePosts)c.creator==t.data.address&&(c.authorStr=t.data.name)}),await this.loadPosts(),this.totalPostCount==0){this.loading=!1;return}this.loadCurrentPage(!0)},unmounted(){this.timer&&(clearInterval(this.timer),this.timer=null)},methods:{async loadPosts(){this.loading=!0;const n=await P.queryForumBatchInfo();console.log("loadPosts",n),this.totalPostCount=parseInt(n.postCount),this.postCost=n.postCost,this.categoryList=[];for(let t=0;t<n.categoryNames.length;t++)this.categoryList.push({label:n.categoryNames[t],value:t+1})},async loadCurrentPage(n){this.loading=n;let t=[];if(this.curPagePosts.length<this.pageSize){const e=Math.ceil(this.totalPostCount/this.pageSize),r=Math.min(this.totalPostCount-(e-this.currentPage)*this.pageSize+this.pageSize,this.totalPostCount);for(let h=0;h<this.pageSize;h++){const u=r-h;if(u>0)t.push(u);else break}}else for(const e of this.curPagePosts)t.push(e.postId);const c=[],C=await P.loadPostList(t);this.curPagePosts.splice(0,this.curPagePosts.length);for(let e=0;e<t.length;e++){const r=C[e];this.curPagePosts.push({id:t[e],title:r.title,category:this.categoryList[r.categoryId-1].label,creator:r.creator,authorStr:S.resolveAddress(r.creator),replies:r.commentCount,createdAt:r.createBlock}),c.push(r.creator)}this.loading=!1,S.addAddressList(c)},handleRowClick(n){this.$router.push(`/post/${n.id}`)},handlePageChange(n){this.currentPage=n,this.loadCurrentPage(!0),window.scrollTo({top:0,behavior:"smooth"})},handleCancelPost(){this.newPost={title:"",category:"",content:""},this.showPostDialog=!1},async handleCreatePost(){if(!this.userStore.isConnected){g.error("Please connect your wallet first");return}if(!this.newPost.title.trim()){g.error("Please enter post title");return}if(!this.newPost.category){g.error("Please select a category");return}if(!this.newPost.content.trim()){g.error("Please enter post content");return}if(await P.loadSatoshiTokenBalance(this.userStore.walletAddress)<this.postCost){g.error("$Satoshi unenough");return}console.log("handleCreatePost",{category:this.newPost.category,title:this.newPost.title,content:this.newPost.content.trim(),price:this.postCost,sender:this.userStore.walletAddress,postCost:this.postCost});let t=this;P.createPost(this.newPost.category,this.newPost.title,this.newPost.content.trim(),this.userStore.walletAddress,this.postCost,function(){t.showPostDialog=!1})}}},H={class:"forum-page"},W={class:"forum-header"},G={class:"post-title"},J={class:"author-name"},K={class:"post-time"},O={class:"pagination-wrapper"},Q={class:"emoji-hint"},X={class:"dialog-footer"};function Z(n,t,c,C,e,r){const h=a("EditPen"),u=a("el-icon"),f=a("el-button"),p=a("el-table-column"),k=a("el-tag"),V=a("el-table"),I=a("el-pagination"),x=a("el-card"),y=a("el-input"),w=a("el-form-item"),z=a("el-option"),D=a("el-select"),B=a("ChatDotRound"),L=a("el-form"),E=a("Promotion"),N=a("el-dialog"),U=R("loading");return m(),b("div",H,[i("div",W,[t[7]||(t[7]=i("h2",null,"Forum",-1)),o(f,{type:"primary",size:"large",onClick:t[0]||(t[0]=s=>e.showPostDialog=!0)},{default:l(()=>[o(u,null,{default:l(()=>[o(h)]),_:1}),t[6]||(t[6]=_(" New Post ",-1))]),_:1})]),o(x,{class:"forum-card"},{default:l(()=>[F((m(),v(V,{data:e.curPagePosts,style:{width:"100%"},"row-style":{cursor:"pointer"},onRowClick:r.handleRowClick},{default:l(()=>[o(p,{label:"Title","min-width":"300"},{default:l(({row:s})=>[i("div",G,d(s.title),1)]),_:1}),o(p,{label:"Category",width:"150"},{default:l(({row:s})=>[o(k,{type:"info"},{default:l(()=>[_(d(s.category),1)]),_:2},1024)]),_:1}),o(p,{label:"Author",width:"200"},{default:l(({row:s})=>[i("span",J,d(s.authorStr),1)]),_:1}),o(p,{label:"Replies",width:"100",align:"center"},{default:l(({row:s})=>[i("span",null,d(s.replies),1)]),_:1}),o(p,{label:"Block #",width:"180"},{default:l(({row:s})=>[i("span",K,d(s.createdAt),1)]),_:1})]),_:1},8,["data","onRowClick"])),[[U,e.loading]]),i("div",O,[o(I,{"current-page":e.currentPage,"onUpdate:currentPage":t[1]||(t[1]=s=>e.currentPage=s),"page-size":e.pageSize,total:r.totalPosts,layout:"prev, pager, next, total",onCurrentChange:r.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])])]),_:1}),o(N,{modelValue:e.showPostDialog,"onUpdate:modelValue":t[5]||(t[5]=s=>e.showPostDialog=s),title:"Create New Post",width:"600px","close-on-click-modal":!1},{footer:l(()=>[i("div",X,[o(f,{onClick:r.handleCancelPost,size:"large"},{default:l(()=>[...t[9]||(t[9]=[_("Cancel",-1)])]),_:1},8,["onClick"]),o(f,{type:"primary",onClick:r.handleCreatePost,size:"large",loading:e.posting},{default:l(()=>[o(u,null,{default:l(()=>[o(E)]),_:1}),_(" Post ("+d(e.postCost/100000000n)+" $Satoshi) ",1)]),_:1},8,["onClick","loading"])])]),default:l(()=>[o(L,{model:e.newPost,"label-width":"100px","label-position":"top"},{default:l(()=>[o(w,{label:"Title",required:""},{default:l(()=>[o(y,{modelValue:e.newPost.title,"onUpdate:modelValue":t[2]||(t[2]=s=>e.newPost.title=s),placeholder:"Enter post title",maxlength:"100","show-word-limit":"",clearable:""},null,8,["modelValue"])]),_:1}),o(w,{label:"Category",required:""},{default:l(()=>[o(D,{modelValue:e.newPost.category,"onUpdate:modelValue":t[3]||(t[3]=s=>e.newPost.category=s),placeholder:"Select category",style:{width:"100%"}},{default:l(()=>[(m(!0),b(T,null,q(e.categoryList,s=>(m(),v(z,{key:s.value,value:s.value,label:s.label},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(w,{label:"Content",required:""},{default:l(()=>[o(y,{modelValue:e.newPost.content,"onUpdate:modelValue":t[4]||(t[4]=s=>e.newPost.content=s),type:"textarea",rows:10,placeholder:"Write your post content here... You can use emoji! 😊 🚀 💎 🔥 ⭐",maxlength:"5000","show-word-limit":""},null,8,["modelValue"]),i("div",Q,[o(u,null,{default:l(()=>[o(B)]),_:1}),t[8]||(t[8]=i("span",null,"Emoji supported! You can copy and paste emoji directly into the content.",-1))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const tt=A(Y,[["render",Z],["__scopeId","data-v-1e265f01"]]);export{tt as default};
