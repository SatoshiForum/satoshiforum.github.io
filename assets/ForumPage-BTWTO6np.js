import{_ as E,c as b,o as m,a as r,b as o,w as l,d as _,r as a,e as F,f as N,g as v,t as u,F as R,h as q,E as p,C as g,U as T,u as j}from"./index-DSfp38Jk.js";const M={name:"ForumPage",data(){return{totalPostCount:0,postCost:0,categoryList:[],postCache:{},curPagePosts:[],currentPage:1,pageSize:20,loading:!1,showPostDialog:!1,posting:!1,newPost:{title:"",category:"",content:""}}},computed:{userStore(){return j()},totalPosts(){return this.totalPostCount}},async mounted(){if(await this.loadPosts(),this.totalPostCount==0){this.loading=!1;return}this.loadCurrentPage(!0)},activated(){let n=this;this.timer=setInterval(async()=>{const t=await g.queryForumBatchInfo(),d=parseInt(t.postCount);d!=n.totalPostCount&&n.currentPage==1&&(n.totalPostCount=d,n.loadCurrentPage(!1))},4e3)},deactivated(){this.timer&&(clearInterval(this.timer),this.timer=null)},methods:{async loadPosts(){this.loading=!0;const n=await g.queryForumBatchInfo();console.log("loadPosts",n),this.totalPostCount=parseInt(n.postCount),this.postCost=n.postCost,this.categoryList=[];for(let t=0;t<n.categoryNames.length;t++)this.categoryList.push({label:n.categoryNames[t],value:t+1})},async loadCurrentPage(n){this.loading=n;let t=[];if(this.curPagePosts.length<this.pageSize){const i=Math.ceil(this.totalPostCount/this.pageSize),e=Math.min(this.totalPostCount-(i-this.currentPage)*this.pageSize+this.pageSize,this.totalPostCount);for(let c=0;c<this.pageSize;c++){const P=e-c;if(P>0)t.push(P);else break}}else for(const i of this.curPagePosts)t.push(i.postId);const d=await g.loadPostList(t);this.curPagePosts.splice(0,this.curPagePosts.length);for(let i=0;i<t.length;i++){const e=d[i];this.curPagePosts.push({id:t[i],title:e.title,category:this.categoryList[e.categoryId-1].label,creator:e.creator,shortAddress:T.makeShortAddress(e.creator),replies:e.commentCount,createdAt:e.createBlock})}this.loading=!1},handleRowClick(n){this.$router.push(`/post/${n.id}`)},handlePageChange(n){this.currentPage=n,this.loadCurrentPage(!0),window.scrollTo({top:0,behavior:"smooth"})},handleCancelPost(){this.newPost={title:"",category:"",content:""},this.showPostDialog=!1},async handleCreatePost(){if(!this.userStore.isConnected){p.error("Please connect your wallet first");return}if(!this.newPost.title.trim()){p.error("Please enter post title");return}if(!this.newPost.category){p.error("Please select a category");return}if(!this.newPost.content.trim()){p.error("Please enter post content");return}if(await g.loadSatoshiTokenBalance(this.userStore.walletAddress)<this.postCost){p.error("$Satoshi unenough");return}console.log("handleCreatePost",{category:this.newPost.category,title:this.newPost.title,content:this.newPost.content.trim(),price:this.postCost,sender:this.userStore.walletAddress,postCost:this.postCost});let t=this;g.createPost(this.newPost.category,this.newPost.title,this.newPost.content.trim(),this.userStore.walletAddress,this.postCost,function(){t.showPostDialog=!1})}}},Y={class:"forum-page"},H={class:"forum-header"},W={class:"post-title"},G={class:"author-name"},J={class:"post-time"},K={class:"pagination-wrapper"},O={class:"emoji-hint"},Q={class:"dialog-footer"};function X(n,t,d,i,e,c){const P=a("EditPen"),f=a("el-icon"),w=a("el-button"),h=a("el-table-column"),k=a("el-tag"),S=a("el-table"),V=a("el-pagination"),I=a("el-card"),y=a("el-input"),C=a("el-form-item"),x=a("el-option"),z=a("el-select"),D=a("ChatDotRound"),A=a("el-form"),B=a("Promotion"),L=a("el-dialog"),U=N("loading");return m(),b("div",Y,[r("div",H,[t[7]||(t[7]=r("h2",null,"Forum",-1)),o(w,{type:"primary",size:"large",onClick:t[0]||(t[0]=s=>e.showPostDialog=!0)},{default:l(()=>[o(f,null,{default:l(()=>[o(P)]),_:1}),t[6]||(t[6]=_(" New Post ",-1))]),_:1})]),o(I,{class:"forum-card"},{default:l(()=>[F((m(),v(S,{data:e.curPagePosts,style:{width:"100%"},"row-style":{cursor:"pointer"},onRowClick:c.handleRowClick},{default:l(()=>[o(h,{label:"Title","min-width":"300"},{default:l(({row:s})=>[r("div",W,u(s.title),1)]),_:1}),o(h,{label:"Category",width:"150"},{default:l(({row:s})=>[o(k,{type:"info"},{default:l(()=>[_(u(s.category),1)]),_:2},1024)]),_:1}),o(h,{label:"Author",width:"200"},{default:l(({row:s})=>[r("span",G,u(s.shortAddress),1)]),_:1}),o(h,{label:"Replies",width:"100",align:"center"},{default:l(({row:s})=>[r("span",null,u(s.replies),1)]),_:1}),o(h,{label:"Block #",width:"180"},{default:l(({row:s})=>[r("span",J,u(s.createdAt),1)]),_:1})]),_:1},8,["data","onRowClick"])),[[U,e.loading]]),r("div",K,[o(V,{"current-page":e.currentPage,"onUpdate:currentPage":t[1]||(t[1]=s=>e.currentPage=s),"page-size":e.pageSize,total:c.totalPosts,layout:"prev, pager, next, total",onCurrentChange:c.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])])]),_:1}),o(L,{modelValue:e.showPostDialog,"onUpdate:modelValue":t[5]||(t[5]=s=>e.showPostDialog=s),title:"Create New Post",width:"600px","close-on-click-modal":!1},{footer:l(()=>[r("div",Q,[o(w,{onClick:c.handleCancelPost,size:"large"},{default:l(()=>[...t[9]||(t[9]=[_("Cancel",-1)])]),_:1},8,["onClick"]),o(w,{type:"primary",onClick:c.handleCreatePost,size:"large",loading:e.posting},{default:l(()=>[o(f,null,{default:l(()=>[o(B)]),_:1}),_(" Post ("+u(e.postCost/100000000n)+" $Satoshi) ",1)]),_:1},8,["onClick","loading"])])]),default:l(()=>[o(A,{model:e.newPost,"label-width":"100px","label-position":"top"},{default:l(()=>[o(C,{label:"Title",required:""},{default:l(()=>[o(y,{modelValue:e.newPost.title,"onUpdate:modelValue":t[2]||(t[2]=s=>e.newPost.title=s),placeholder:"Enter post title",maxlength:"100","show-word-limit":"",clearable:""},null,8,["modelValue"])]),_:1}),o(C,{label:"Category",required:""},{default:l(()=>[o(z,{modelValue:e.newPost.category,"onUpdate:modelValue":t[3]||(t[3]=s=>e.newPost.category=s),placeholder:"Select category",style:{width:"100%"}},{default:l(()=>[(m(!0),b(R,null,q(e.categoryList,s=>(m(),v(x,{key:s.value,value:s.value,label:s.label},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(C,{label:"Content",required:""},{default:l(()=>[o(y,{modelValue:e.newPost.content,"onUpdate:modelValue":t[4]||(t[4]=s=>e.newPost.content=s),type:"textarea",rows:10,placeholder:"Write your post content here... You can use emoji! 😊 🚀 💎 🔥 ⭐",maxlength:"5000","show-word-limit":""},null,8,["modelValue"]),r("div",O,[o(f,null,{default:l(()=>[o(D)]),_:1}),t[8]||(t[8]=r("span",null,"Emoji supported! You can copy and paste emoji directly into the content.",-1))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const $=E(M,[["render",X],["__scopeId","data-v-70d07f5b"]]);export{$ as default};
